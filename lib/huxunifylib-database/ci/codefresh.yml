version: "1.0"
stages:
  - clone
  - pylint_&_unittest_check
  - coverage_style_check
  - publish

steps:

  clone:
    stage: "clone"
    title: "Cloning repository"
    type: "git-clone"
    repo: "DeloitteHux/hux-unified"
    revision: "${{CF_BRANCH}}"
    git: "DeloitteHux_github"

  safety_test_check:
    stage: "pylint_&_unittest_check"
    title: "Pylint and Unittest check"
    image: huxhub.repo.mgnt.in/tox-ci
    working_directory: '${{CF_REPO_NAME}}/lib/huxunifylib-database'
    description: "run tests using tox"
    commands:
      - tox -e ${TOXENV} -- --skip-model-generate
    scale:
      py37:
        title: 'tests'
        environment:
          - TOXENV=py37
      pylintCheck:
        title: 'pylintCheck'
        environment:
          - TOXENV=pylintCheck
    fail_fast: false

  coverageStyleCheck:
    stage: "coverage_style_check"
    title: "Coverage and Style checks."
    image: huxhub.repo.mgnt.in/tox-ci
    working_directory: '${{CF_REPO_NAME}}/lib/huxunifylib-database'
    description: "run tests using tox"
    commands:
      - tox -e ${TOXENV} -- --skip-model-generate
    scale:
      checkCoverage:
        title: 'checkCoverage'
        environment:
          - TOXENV=checkCoverage
    fail_fast: false

  publish:
    stage: publish
    when:
      branch:
        only:
          - /^lib.*/i
    description: "Publish the package on server tag creation"
    image: "python:3.7-buster"
    working_directory: "/codefresh/volume/${{CF_REPO_NAME}}/lib/huxunifylib-database"
    commands:
      - pip install --upgrade pip
      - pip install build twine
      - rm -rf ./dist
      - python -m build -s -w . --outdir ./dist
      - twine upload ./dist/*
    environment:
      - TWINE_USERNAME=${{TWINE_USERNAME}}
      - TWINE_PASSWORD=${{TWINE_PASSWORD}}
      - TWINE_REPOSITORY_URL=${{ARTIFACTORY_PYTHON_WRITE}}
