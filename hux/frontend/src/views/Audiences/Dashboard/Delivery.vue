<template>
  <v-card class="rounded-lg card-style delivery-overview mt-4" flat>
    <v-card-title class="d-flex justify-space-between pb-4 pl-6 pt-5">
      <slot name="title-left"></slot>
      <slot name="title-right"></slot>
    </v-card-title>
    <v-progress-linear
      v-if="loadingRelationships"
      :active="loadingRelationships"
      :indeterminate="loadingRelationships"
    />
    <v-card-text v-else class="pl-6 pr-6 pb-6 pt-0">
      <div
        v-if="sections.length == 0"
        class="empty-state py-4 black--text text--lighten-4 text-body-1"
      >
        This audience is not part of an engagement. Add it to an engagement
        below.
      </div>
      <div v-else class="pl-0 pt-0 pr-0 overflow-auto pb-0">
        <delivery-details
          v-for="item in availableRelationships"
          :key="item.id"
          :section="item"
          :status-icon="17"
          :menu-items="sectionActions"
          :deliveries-key="deliveriesKey"
          :section-type="sectionType"
          :destination-menu-items="destinationActions"
          data-e2e="status-list"
          class="mb-2"
          :audience="audienceData"
          @onSectionAction="$emit('onOverviewSectionAction', $event)"
          @onDestinationAction="$emit('onOverviewDestinationAction', $event)"
          @onAddDestination="$emit('onAddDestination', $event)"
          @engagementDeliverySection="$emit('engagementDeliveries', $event)"
          @refreshEntityDelivery="$emit('refreshEntityInsight')"
        >
          <template #empty-destinations>
            <slot name="empty-deliveries" :sectionId="item.id" />
          </template>
        </delivery-details>
      </div>
      <v-list dense class="add-engagement ma-0 pa-0 py-2" :height="22">
        <v-list-item>
          <hux-icon type="plus" :size="16" color="primary" class="mr-4 ml-2" />
          <v-btn
            text
            min-width="7rem"
            height="2rem"
            class="primary--text text-body-1"
            data-e2e="drawerToggle"
            @click="$emit('addEngagement')"
          >
            An engagement
          </v-btn>
        </v-list-item>
      </v-list>
    </v-card-text>
  </v-card>
</template>

<script>
import DeliveryDetails from "@/components/common/DeliveryDetails.vue"
import HuxIcon from "@/components/common/Icon.vue"
import { getAccess } from "@/utils"

export default {
  name: "Delivery",
  components: { DeliveryDetails, HuxIcon },
  props: {
    sections: {
      type: Array,
      required: false,
      default: () => [],
    },
    sectionType: {
      type: String,
      required: true,
      default: "engagement",
    },
    deliveriesKey: {
      type: String,
      required: true,
      default: "destinations",
    },
    loadingRelationships: {
      type: Boolean,
      required: false,
      default: false,
    },
    audienceData: {
      type: Object,
      required: false,
    },
  },
  data() {
    return {
      engagementMenuOptions: [
        { id: 1, title: "View delivery history", active: false },
        {
          id: 2,
          title: "Deliver all",
          active: true,
          isHidden: !this.getAccess("delivery", "deliver"),
        },
        {
          id: 3,
          title: "Add a destination",
          active: true,
          isHidden: !this.getAccess(
            "engagements",
            "add_destination_to_engagement"
          ),
        },
        {
          id: 5,
          title: "Remove engagement",
          active: false,
          isHidden: !this.getAccess("engagements", "delete_one"),
        },
      ],
      destinationMenuOptions: [
        {
          id: 2,
          title: "Create lookalike",
          active: false,
          isHidden: !this.getAccess("audience", "create_lookalike"),
        },
        {
          id: 1,
          title: "Deliver now",
          active: true,
          isHidden: !this.getAccess("delivery", "deliver"),
        },
        {
          id: 3,
          title: "Edit delivery schedule",
          active: true,
          isHidden: !this.getAccess("delivery", "schedule_delivery"),
        },
        { id: 4, title: "Pause delivery", active: false },
        { id: 5, title: "Open destination", active: false },
        {
          id: 6,
          title: "Remove destination",
          active: false,
          isHidden: !this.getAccess(
            "engagements",
            "remove_destination_from_engagement"
          ),
        },
      ],
      audienceMenuOptions: [
        {
          id: 1,
          title: "Deliver now",
          active: false,
          isHidden: !this.getAccess("delivery", "deliver"),
        },
        {
          id: 2,
          title: "Add a destination",
          active: true,
          isHidden: !this.getAccess(
            "engagements",
            "add_destination_to_engagement"
          ),
        },
        {
          id: 3,
          title: "Create lookalike",
          active: false,
          isHidden: !this.getAccess("audience", "create_lookalike"),
        },
        { id: 4, title: "Pause all delivery", active: false },
        {
          id: 5,
          title: "Remove audience",
          active: true,
          isHidden: !this.getAccess(
            "engagements",
            "remove_audience_from_engagement"
          ),
        },
      ],
    }
  },
  computed: {
    availableRelationships() {
      return this.sections
    },
    sectionActions() {
      return this.sectionType === "engagement"
        ? this.engagementMenuOptions.filter((x) => !x.isHidden)
        : this.audienceMenuOptions.filter((x) => !x.isHidden)
    },
    destinationActions() {
      return this.sectionType === "engagement"
        ? this.destinationMenuOptions.filter((x) => !x.isHidden)
        : []
    },
  },
  methods: {
    getAccess: getAccess,
  },
}
</script>

<style lang="scss" scoped>
.delivery-overview {
  .add-engagement {
    height: 60px !important;
    display: inline-table;
    width: 100%;
    background: var(--v-primary-lighten1);
    border: 1px solid var(--v-black-lighten2);
    border-radius: 5px;
  }
}
</style>
